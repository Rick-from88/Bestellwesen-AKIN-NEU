<!doctype html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bestellwesen Dashboard</title>
    <link rel="stylesheet" href="/static/styles/uebersicht.css" />
  </head>
  <body>
    <div class="page">
      <header class="hero">
        <h1>Dashboard</h1>
        <p class="hero__subtitle">
          Schneller Blick auf Bestellungen, Lieferanten und Artikel.
        </p>
        <div class="hero__actions">
          <a class="btn btn--primary" href="/bestellung-neu">Neue Bestellung</a>
          <a class="btn btn--ghost" href="/lieferanten">Lieferanten</a>
        </div>
      </header>

      <section class="grid">
        <article class="card">
          <div class="card__label">Offene Bestellungen</div>
          <div class="card__value">24</div>
          <div class="card__trend">+5 seit letzter Woche</div>
        </article>
        <article class="card">
          <div class="card__label">Gefaellige Lieferanten</div>
          <div class="card__value" id="lieferantenCount">0</div>
          <div class="card__trend" id="lieferantenTrend">Noch keine Daten</div>
        </article>
        <article class="card">
          <div class="card__label">Artikel im Fokus</div>
          <div class="card__value" id="artikelCount">0</div>
          <div class="card__trend" id="lowStockCount">Noch keine Daten</div>
        </article>
      </section>

      <section class="split">
        <div class="panel">
          <div class="panel__header">
            <h2>Letzte Bestellungen</h2>
            <a class="btn btn--link" href="/bestellungen">Alle anzeigen</a>
          </div>
          <div class="list" id="letzteBestellungenList"></div>
        </div>

        <div class="panel">
          <div class="panel__header">
            <h2>Heute wichtig</h2>
            <button class="btn btn--link">Mehr</button>
          </div>
          <div class="alert">
            <div class="alert__title">3 Angebote laufen aus</div>
            <p>
              Pruefe die Lieferantenpreise bis 16:00, um Staffelrabatte zu
              sichern.
            </p>
          </div>
          <div class="timeline">
            <div class="timeline__item">
              <div class="timeline__time">09:30</div>
              <div>
                <div class="timeline__title">Freigabe Einkauf IT</div>
                <div class="timeline__meta">Budget: 18.400 EUR</div>
              </div>
            </div>
            <div class="timeline__item">
              <div class="timeline__time">11:15</div>
              <div>
                <div class="timeline__title">Lieferantencheck</div>
                <div class="timeline__meta">Datenimport abgeschlossen</div>
              </div>
            </div>
            <div class="timeline__item">
              <div class="timeline__time">15:00</div>
              <div>
                <div class="timeline__title">Bestellung versenden</div>
                <div class="timeline__meta">Nachbearbeitung offen</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="split">
        <div class="panel">
          <div class="panel__header">
            <h2>Low-Stock Warnungen</h2>
            <button class="btn btn--link" id="lowStockRefresh">
              Aktualisieren
            </button>
          </div>
          <div class="list" id="lowStockList"></div>
        </div>
        <div class="panel">
          <div class="panel__header">
            <h2>Schnellzugriff</h2>
          </div>
          <div class="list">
            <a class="list__row" href="/lieferanten">
              <div>
                <div class="list__title">Lieferanten verwalten</div>
                <div class="list__meta">Alle Lieferanten anzeigen</div>
              </div>
            </a>
            <a class="list__row" href="/bestellung-neu">
              <div>
                <div class="list__title">Neue Bestellung</div>
                <div class="list__meta">Bestellung erfassen</div>
              </div>
            </a>
          </div>
        </div>
      </section>
    </div>

    <nav class="navbar">
      <a class="navbar__item is-active" href="/uebersicht">Dashboard</a>
      <a class="navbar__item" href="/bestellungen">Bestellungen</a>
      <a class="navbar__item" href="/lieferanten">Lieferanten</a>
      <a class="navbar__item" href="#">Artikel</a>
      <a class="navbar__item" href="#">Einstellungen</a>
    </nav>

    <script>
      const lieferantenCount = document.getElementById("lieferantenCount");
      const lieferantenTrend = document.getElementById("lieferantenTrend");
      const artikelCount = document.getElementById("artikelCount");
      const lowStockCount = document.getElementById("lowStockCount");
      const lowStockList = document.getElementById("lowStockList");
      const lowStockRefresh = document.getElementById("lowStockRefresh");
      const letzteBestellungenList = document.getElementById(
        "letzteBestellungenList",
      );

      const statusClass = (status) => {
        if (status === "geliefert") {
          return "pill pill--mint";
        }
        if (status === "storniert") {
          return "pill pill--rose";
        }
        return "pill pill--amber";
      };

      const formatDate = (value) => {
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) {
          return "-";
        }
        return date.toLocaleDateString("de-DE");
      };

      const renderLetzteBestellungen = (bestellungen, artikelMap, lieferantMap) => {
        letzteBestellungenList.innerHTML = "";
        if (!bestellungen.length) {
          const emptyRow = document.createElement("div");
          emptyRow.className = "list__row";
          emptyRow.textContent = "Keine Bestellungen vorhanden.";
          letzteBestellungenList.appendChild(emptyRow);
          return;
        }

        bestellungen.slice(0, 3).forEach((bestellung) => {
          const row = document.createElement("div");
          row.className = "list__row";

          const leftDiv = document.createElement("div");
          const title = document.createElement("div");
          title.className = "list__title";
          const erstePosition = Array.isArray(bestellung.positionen)
            ? bestellung.positionen[0]
            : null;
          const artikelName = erstePosition
            ? artikelMap[erstePosition.artikelId] || `Artikel #${erstePosition.artikelId}`
            : `Bestellung #${bestellung.id}`;
          title.textContent = artikelName;

          const meta = document.createElement("div");
          meta.className = "list__meta";
          const lieferantName = erstePosition
            ? lieferantMap[erstePosition.lieferantId] || `Lieferant #${erstePosition.lieferantId}`
            : "";
          const datum = formatDate(bestellung.bestellDatum);
          meta.textContent = lieferantName
            ? `${lieferantName} | ${datum}`
            : datum;

          leftDiv.appendChild(title);
          leftDiv.appendChild(meta);

          const status = document.createElement("span");
          status.className = statusClass(bestellung.status);
          status.textContent = bestellung.status;

          row.appendChild(leftDiv);
          row.appendChild(status);
          letzteBestellungenList.appendChild(row);
        });
      };

      const renderLowStock = (artikel) => {
        lowStockList.innerHTML = "";
        if (!artikel.length) {
          const emptyRow = document.createElement("div");
          emptyRow.className = "list__row";
          emptyRow.textContent = "Keine Low-Stock Artikel.";
          lowStockList.appendChild(emptyRow);
          return;
        }

        artikel.forEach((item) => {
          const row = document.createElement("div");
          row.className = "list__row";
          const title = document.createElement("div");
          title.className = "list__title";
          title.textContent = item.name;
          const meta = document.createElement("div");
          meta.className = "list__meta";
          meta.textContent = `Lager: ${item.lagerbestand} | Min: ${item.minBestand}`;
          row.appendChild(title);
          row.appendChild(meta);
          lowStockList.appendChild(row);
        });
      };

      const loadLieferanten = async () => {
        const response = await fetch("/api/lieferanten");
        const lieferanten = await response.json();
        lieferantenCount.textContent = lieferanten.length;
        lieferantenTrend.textContent = lieferanten.length
          ? "Profil gepflegt"
          : "Noch keine Daten";
      };

      const loadArtikel = async () => {
        const response = await fetch("/api/artikel");
        const artikel = await response.json();
        artikelCount.textContent = artikel.length;
        const lowStock = artikel.filter(
          (item) => item.lagerbestand <= item.minBestand,
        );
        lowStockCount.textContent = `${lowStock.length} Low-Stock`;
        renderLowStock(lowStock);
      };

      const loadLetzteBestellungen = async () => {
        try {
          const [bestellungenRes, artikelRes, lieferantenRes] = await Promise.all([
            fetch("/api/bestellungen"),
            fetch("/api/artikel"),
            fetch("/api/lieferanten"),
          ]);

          const bestellungen = await bestellungenRes.json();
          const artikel = await artikelRes.json();
          const lieferanten = await lieferantenRes.json();

          const artikelMap = artikel.reduce((acc, item) => {
            acc[item.id] = item.name;
            return acc;
          }, {});

          const lieferantMap = lieferanten.reduce((acc, item) => {
            acc[item.id] = item.name;
            return acc;
          }, {});

          renderLetzteBestellungen(bestellungen, artikelMap, lieferantMap);
        } catch (error) {
          console.error("Fehler beim Laden der Bestellungen:", error);
        }
      };

      lowStockRefresh.addEventListener("click", loadArtikel);

      loadLieferanten();
      loadArtikel();
      loadLetzteBestellungen();
    </script>
  </body>
</html>
